tmp2 <- poblacion_muni %>%  group_by(ageRange,status) %>%
summarize(n2=sum(n,na.rm=TRUE))
tmp3 <-filter(poblacion_muni, municipio=="No reportado" & status !="UNV") %>%
group_by(ageRange) %>% summarize(n3=sum(n),.groups = "drop")
tmp <- tmp1 %>% left_join(tmp2) %>% left_join(tmp3)
tmp
tmp %>% View
tmp %>% mutate(diff= n2-n1) %>% View
poblacion_muni
tmp1 <- poblacion %>% group_by(ageRange,status) %>%
summarize(n1=sum(n,na.rm=TRUE))
tmp2 <- poblacion_muni %>%  group_by(ageRange,status) %>%
summarize(n2=sum(n,na.rm=TRUE))
tmp3 <-filter(poblacion_muni, municipio=="No reportado" & status !="UNV" & gender!="O") %>%
group_by(ageRange) %>% summarize(n3=sum(n),.groups = "drop")
tmp <- tmp1 %>% left_join(tmp2) %>% left_join(tmp3)
with(filter(tmp, status=="UNV"), plot(n3,(n2-n1)))
tmp %>% mutate(diff= n2-n1) %>% View
### PIRAMIDE
tab <- poblacion %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = ifelse(gender=="M", -n, n)) %>%
arrange(gender, ageRange) %>%
mutate(n = n/sum(abs(n))) %>%
mutate(etatus = recode(status, UNV = "No vacunados", PAR = "Parcial", VAX = "Vacunados")) %>%
rename(estatus = status)
tab
tab_muni <- poblacion_muni %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(municipio, ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = ifelse(gender=="M", -n, n)) %>%
arrange(gender, ageRange) %>%
mutate(n = n/sum(abs(n))) %>%
mutate(etatus = recode(status, UNV = "No vacunados", PAR = "Parcial", VAX = "Vacunados")) %>%
rename(estatus = status) %>%
mutate(municipio == "Todos")
tab_muni
poblacion_muni
tab_muni <- poblacion_muni %>%
filter(date == max(date) & gender %in% c("M","F"))
tab_muni
tab_muni <- poblacion_muni %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(municipio, ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = pmax(0, n)) %>%
mutate(n = ifelse(gender=="M", -n, n)) %>%
arrange(gender, ageRange) %>%
mutate(n = n/sum(abs(n))) %>%
mutate(etatus = recode(status, UNV = "No vacunados", PAR = "Parcial", VAX = "Vacunados")) %>%
rename(estatus = status)
tab_muni
### by municipio
unvax <- counts_onedose_age_gender_manu_muni[ , .(total = sum(n)),
keyby = .(date, ageRange, gender, municipio)]
unvax <- merge(unvax, pop_by_age_gender_municipio, all.x = TRUE,
by = c("ageRange", "gender", "municipio"))
unvax[, n := poblacion - total]
unvax[ ,manu := "UNV"]
unvax <- unvax[,c("date", "municipio","ageRange","gender","manu", "n")]
poblacion_muni <- rbind(counts_vax_age_gender_manu_muni[,status:="VAX"],
counts_partial_age_gender_manu_muni[,status:="PAR"],
unvax[,status:="UNV"])
poblacion_muni$status <- factor(poblacion_muni$status, levels = c("UNV", "PAR", "VAX"))
poblacion_muni$ageRange <- factor(poblacion_muni$ageRange, levels = age_levels)
poblacion_muni$municipio <-
factor(poblacion_muni$municipio, levels = muni_levels)
### PIRAMIDE
tab <- poblacion %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = pmax(0, n)) %>%
mutate(n = ifelse(gender=="M", -n, n)) %>%
arrange(gender, ageRange) %>%
mutate(n = n/sum(abs(n))) %>%
mutate(etatus = recode(status, UNV = "No vacunados", PAR = "Parcial", VAX = "Vacunados")) %>%
rename(estatus = status) %>%
mutate(municipio = "Todos")
tab_muni <- poblacion_muni %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(municipio, ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = pmax(0, n)) %>%
mutate(n = ifelse(gender=="M", -n, n)) %>%
arrange(gender, ageRange) %>%
mutate(n = n/sum(abs(n))) %>%
mutate(etatus = recode(status, UNV = "No vacunados", PAR = "Parcial", VAX = "Vacunados")) %>%
rename(estatus = status)
tab_muni
poblacion_muni
ab_muni <- poblacion_muni %>%
filter(date == max(date) & gender %in% c("M","F"))
ab_muni
ab_muni%>%Vieww
ab_muni%>%View()
poblacion_muni %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(municipio, ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = pmax(0, n))
poblacion_muni %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(municipio, ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = pmax(0, n)) %>%
mutate(n = ifelse(gender=="M", -n, n))
tab_muni <- poblacion_muni %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(municipio, ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = pmax(0, n)) %>%
mutate(n = ifelse(gender=="M", -n, n)) %>%
arrange(gender, ageRange, municipio) %>%
mutate(n = n/sum(abs(n))) %>%
mutate(etatus = recode(status, UNV = "No vacunados", PAR = "Parcial", VAX = "Vacunados")) %>%
rename(estatus = status)
tab_muni
tab_muni <- poblacion_muni %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(municipio, ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = pmax(0, n)) %>%
mutate(n = ifelse(gender=="M", -n, n))
tab_muni
tab_muni %>% View()
tab_muni <- poblacion_muni %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(municipio, ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = pmax(0, n)) %>%
mutate(n = ifelse(gender=="M", -n, n)) %>%
arrange(gender, ageRange, municipio) %>%
mutate(n = n/sum(abs(n))) #%>%
tab_muni
tab_muni <- poblacion_muni %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(municipio, ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = pmax(0, n)) %>%
mutate(n = ifelse(gender=="M", -n, n)) %>%
arrange(municipio, gender, ageRange) %>%
group_by(municipio) %>%
mutate(n = n/sum(abs(n))) %>%
ungroup() %>%
mutate(etatus = recode(status, UNV = "No vacunados", PAR = "Parcial", VAX = "Vacunados")) %>%
rename(estatus = status)
tab_muni
tab_muni <- poblacion_muni %>%
filter(municipio!="No reportado") %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(municipio, ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = pmax(0, n)) %>%
mutate(n = ifelse(gender=="M", -n, n)) %>%
arrange(municipio, gender, ageRange) %>%
group_by(municipio) %>%
mutate(n = n/sum(abs(n))) %>%
ungroup() %>%
mutate(etatus = recode(status, UNV = "No vacunados", PAR = "Parcial", VAX = "Vacunados")) %>%
rename(estatus = status)
tab_muni
piramide <- bind_rows(tab, tab_muni)
piramide
save(piramide, file = file.path(rda_path, "piramide.rda"))
shiny::runApp()
runApp()
piramide_tab <- daily_vax_counts %>%
filter(gender %in% c("M", "F")) %>%
group_by(ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender, by = c("ageRange", "gender")) %>%
mutate(onedose = make_col(onedose, poblacion),
full = make_col(full, poblacion),
immune = make_col(immune, poblacion),
booster = make_col(booster, poblacion),
poblacion = make_pretty(round(poblacion))) %>%
select(ageRange, gender, poblacion, onedose, full, immune, booster)
piramide_tab <- daily_vax_counts %>%
filter(gender %in% c("M", "F")) %>%
group_by(ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender, by = c("ageRange", "gender")) %>%
mutate(onedose = make_col(onedose, poblacion),
full = make_col(full, poblacion),
immune = make_col(immune, poblacion),
booster = make_col(booster, poblacion),
poblacion = make_pretty(round(poblacion))) %>%
select(ageRange, gender, poblacion, onedose, full, immune, booster)
piramide_tab <- daily_vax_counts %>%
filter(gender %in% c("M", "F")) %>%
group_by(ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender, by = c("ageRange", "gender")) %>%
mutate(onedose = make_col(onedose, poblacion),
full = make_col(full, poblacion),
immune = make_col(immune, poblacion),
booster = make_col(booster, poblacion),
poblacion = make_pretty(round(poblacion))) %>%
select(ageRange, gender, poblacion, onedose, full, immune, booster)
piramide_tab <- daily_vax_counts %>%
filter(gender %in% c("M", "F")) %>%
group_by(ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender, by = c("ageRange", "gender")) %>%
mutate(municipio = "Todos")
piramide_tab_muni <- daily_vax_counts_muni %>%
filter(municipio!="No reportado") %>%
filter(gender %in% c("M", "F")) %>%
group_by(municipio, ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender_municipio, by = c("municipio","ageRange", "gender"))
piramide_tab_muni <- daily_vax_counts_by_municipio %>%
filter(municipio!="No reportado") %>%
filter(gender %in% c("M", "F")) %>%
group_by(municipio, ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender_municipio, by = c("municipio","ageRange", "gender"))
piramide_tab <- daily_vax_counts %>%
filter(gender %in% c("M", "F")) %>%
group_by(ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender, by = c("ageRange", "gender")) %>%
mutate(municipio = "Todos")
piramide_tab_muni <- daily_vax_counts_by_municipio %>%
filter(municipio!="No reportado") %>%
filter(gender %in% c("M", "F")) %>%
group_by(municipio, ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender_municipio, by = c("municipio","ageRange", "gender"))
piramide_tab <- bind_row(piramide_tab, piramide_tab_muni)
piramide_tab <- row_bind(piramide_tab, piramide_tab_muni)
piramide_tab <- bind_rows(piramide_tab, piramide_tab_muni)
piramdie_tab
piramide_tab
save(piramide, piramide_tab, file = file.path(rda_path, "piramide.rda"))
runApp()
save(piramide, piramide_tab, file = file.path(rda_path, "piramide.rda"))
save(piramide, piramide_tab, file = file.path(rda_path, "piramide.rda"))
runApp()
piramide_tab
piramide_tab$municipio
piramide_tab <- daily_vax_counts %>%
filter(gender %in% c("M", "F")) %>%
group_by(ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender, by = c("ageRange", "gender")) %>%
mutate(municipio = "Todos")
piramide_tab_muni <- daily_vax_counts_by_municipio %>%
filter(municipio!="No reportado") %>%
filter(gender %in% c("M", "F")) %>%
group_by(municipio, ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender_municipio, by = c("municipio","ageRange", "gender"))
piramide_tab <- bind_rows(piramide_tab, piramide_tab_muni)
piramide_tab
piramide_tab_muni
piramide_tab_muni <- daily_vax_counts_by_municipio %>%
filter(municipio!="No reportado")
piramide_tab_muni
daily_vax_counts_by_municipio
daily_vax_counts_by_municipio$municipio
source("wrangle.R")
piramide_tab
piramide_tab$municipio
shiny::runApp()
piramide_tab
piramide_tab %>% VIew
piramide_tab %>% View
daily_vax_counts_by_municipio
daily_vax_counts
piramide_tab_muni <- daily_vax_counts_by_municipio %>%
filter(date == max(date) & gender %in% c("M", "F") &
municipio!="No reportado") %>%
group_by(municipio, ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender_municipio, by = c("municipio","ageRange", "gender"))
piramide_tab_muni
piramide_tab <- daily_vax_counts %>%
filter(gender %in% c("M", "F")) %>%
group_by(ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender, by = c("ageRange", "gender")) %>%
mutate(municipio = "Todos")
piramide_tab
piramide_tab_muni <- daily_vax_counts_by_municipio %>%
filter(dgender %in% c("M", "F") &  municipio!="No reportado") %>%
group_by(municipio, ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender_municipio, by = c("municipio","ageRange", "gender"))
piramide_tab_muni <- daily_vax_counts_by_municipio %>%
filter(dgender %in% c("M", "F") & municipio!="No reportado") %>%
group_by(municipio, ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender_municipio, by = c("municipio","ageRange", "gender"))
piramide_tab_muni <- daily_vax_counts_by_municipio %>%
filter(gender %in% c("M", "F") & municipio!="No reportado") %>%
group_by(municipio, ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender_municipio, by = c("municipio","ageRange", "gender"))
piramide_tab_muni
piramide_tab <- daily_vax_counts %>%
filter(gender %in% c("M", "F")) %>%
group_by(ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender, by = c("ageRange", "gender")) %>%
mutate(municipio = "Todos")
piramide_tab_muni <- daily_vax_counts_by_municipio %>%
filter(gender %in% c("M", "F") & municipio!="No reportado") %>%
group_by(municipio, ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender_municipio, by = c("municipio","ageRange", "gender"))
piramide_tab <- bind_rows(piramide_tab, piramide_tab_muni)
piramide_tab
piramide_tab %>% filter(ageRange == "30-39")
save(piramide, piramide_tab, file = file.path(rda_path, "piramide.rda"))
runApp()
priamide_tab
piramide_tab
piramide_tab %>% fitler(ageRange == "30-39")
piramide_tab %>% filter(ageRange == "30-39")
piramide_tab %>% filter(municipio=="Aguada"
)
piramide_tab %>% filter(municipio=="Aguada")
piramide_tab  %>%
mutate(onedose = make_col(onedose, poblacion),
full = make_col(full, poblacion),
immune = make_col(immune, poblacion),
booster = make_col(booster, poblacion),
poblacion = make_pretty(round(poblacion))) %>%
select(ageRange, gender, poblacion, onedose, full, immune, booster) %>%
kbl(col.names = c("Grupo de Edad", "Sexo", "Población", "Una dosis", "Dosis completa", "Dosis complete sin necesidad de Booster", "Con booster"),
align = c("c","c", rep("r", 9)))  %>%
kable_styling()
runApp()
runApp()
runApp()
piramide_tab
runApp()
piramide_tab
runApp()
tab <- piramide_tab %>%
filter(!municipios %in% c("Todos", "No reportados"))
tab <- piramide_tab %>%
filter(!municipio %in% c("Todos", "No reportados"))
runApp()
tab <- piramide_tab %>%
filter(!municipio %in% c("Todos", "No reportados"))
tab
runApp()
>
tab <- piramide_dat %>%
filter(!municipios %in% c("Todos","No reportados"))
min_rate <- .40
tab <- piramide_tab %>%
filter(!municipio %in% c("Todos", "No reportados"))
min_rate <- .40
max_rate <- .70
tab <- tab %>% filter(ageRange == input$municipio_agerange)
tab <- piramide_tab %>%
filter(!municipio %in% c("Todos", "No reportados"))
min_rate <- .40
max_rate <- .70
tab %>%  group_by(municipio) %>%
summarize(onedose = sum(onedose),
full = sum(full),
lost = sum(lost),
immune = sum(immune),
poblacion = sum(poblacion), .groups = "drop") %>%
mutate(rate = full/ poblacion) %>%
mutate(rate = 100*pmin(pmax(rate, min_rate), max_rate)) %>%
na.omit() %>%
left_join(map, by = "municipio") %>%
ggplot() +
geom_polygon(aes(x = X, y = Y, group = paste(municipio, part), fill = rate), color = "black", size = 0.15) +
geom_text(mapping = aes(x = X, y = Y, label = municipio), data = map_centers,
size  = 2.0,
color = "black") +
scale_fill_gradientn(colors = rev(RColorBrewer::brewer.pal(9, "Reds")),
name = "Por ciento con dosis completa:",
limits= c(100*min_rate, 100*max_rate)) +
coord_map() +
theme_void() +
theme(legend.position = "bottom")
tab %>%  group_by(municipio) %>%
summarize(onedose = sum(onedose),
full = sum(full),
lost = sum(lost),
immune = sum(immune),
poblacion = sum(poblacion), .groups = "drop")
tab %>%  group_by(municipio) %>%
summarize(onedose = sum(onedose),
full = sum(full),
lost = sum(lost),
immune = sum(immune),
poblacion = sum(poblacion), .groups = "drop") %>%
mutate(rate = full/ poblacion)
tab %>%  group_by(municipio) %>%
summarize(onedose = sum(onedose),
full = sum(full),
lost = sum(lost),
immune = sum(immune),
poblacion = sum(poblacion), .groups = "drop") %>%
mutate(rate = full/ poblacion) %>%
mutate(rate = 100*pmin(pmax(rate, min_rate), max_rate))
map
load(file.path(rda_path, "map.rda"))
tab %>%  group_by(municipio) %>%
summarize(onedose = sum(onedose),
full = sum(full),
lost = sum(lost),
immune = sum(immune),
poblacion = sum(poblacion), .groups = "drop") %>%
mutate(rate = full/ poblacion) %>%
mutate(rate = 100*pmin(pmax(rate, min_rate), max_rate)) %>%
na.omit() %>%
left_join(map, by = "municipio") %>%
ggplot() +
geom_polygon(aes(x = X, y = Y, group = paste(municipio, part), fill = rate), color = "black", size = 0.15) +
geom_text(mapping = aes(x = X, y = Y, label = municipio), data = map_centers,
size  = 2.0,
color = "black") +
scale_fill_gradientn(colors = rev(RColorBrewer::brewer.pal(9, "Reds")),
name = "Por ciento con dosis completa:",
limits= c(100*min_rate, 100*max_rate)) +
coord_map() +
theme_void() +
theme(legend.position = "bottom")
tab <- piramide_tab %>%
filter(!municipios %in% c("Todos","No reportados"))
load(file.path(rda_path, "piramide.rda"))
tab <- piramide_tab %>%
filter(!municipios %in% c("Todos","No reportados"))
tab <- piramide_tab %>%
filter(!municipio %in% c("Todos","No reportados"))
min_rate <- .40
make_col <- function(x,n) paste0(make_pretty(x), " (", make_pct(x/n,0), ")")
tab  %>%  group_by(municipio) %>%
summarize(onedose = sum(onedose),
full = sum(full),
lost = sum(lost),
immune = sum(immune),
poblacion = sum(poblacion), .groups = "drop") %>%
arrange(full/poblacion) %>%
mutate(oonedose = onedose/poblacion,
onedose = make_col(onedose, poblacion),
ofull = full/poblacion,
full = make_col(full, poblacion),
oimmune = immune/poblacion,
immune = make_col(immune, poblacion),
obooster = booster/poblacion,
booster = make_col(booster, poblacion),
opoblacion = poblacion,
poblacion = make_pretty(round(poblacion))) %>%
select(municipio, poblacion, onedose, full, immune, booster,
opoblacion, oonedose, ofull, oimmune, obooster) %>%
setNames(c("Municipio", "Población", "Una dosis", "Dosis completa", "Dosis complete sin necesidad de Booster", "Con booster",
"opoblacion", "oonedose", "ofull", "oimmune", "obooster"))%>%
DT::datatable(rownames = FALSE,
options = list(dom = 't', pageLength = -1,
columnDefs = list(list(targets = 1, orderData = 6),
list(targets = 2, orderData = 7),
list(targets = 3, orderData = 8),
list(targets = 4, orderData = 9),
list(targets = 5, orderData = 10),
list(targets = 6:10, visible = FALSE),
list(className = 'dt-left', targets = 0),
list(className = 'dt-right', targets = 1:5)))) %>%
DT::formatStyle(1, "white-space" = "nowrap")
runApp()
piramide_tab
runApp()
source("wrangle-population-data.R")
source("wrangle.R")
shiny::runApp()
