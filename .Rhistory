### quick check
tmp <- dat_cases %>% left_join(bp_preis_map, by = "caseId") %>%
left_join(dat_vax, by = c("PATIENT_ID" = "id"))
print(mean(tmp$dose_1==tmp$date_1,na.rm=TRUE))
print(mean(tmp$dose_2==tmp$date_2,na.rm=TRUE))
print(c(sum(!is.na(tmp$dose_1)), sum(!is.na(tmp$date_1))))
print(c(sum(!is.na(tmp$dose_2)), sum(!is.na(tmp$date_2))))
dat_cases <- dat_cases %>% select(-dose_1, -dose_2, -manu) %>%
left_join(bp_preis_map, by = "caseId") %>%
left_join(dat_vax, by = c("PATIENT_ID" = "id"))
dat_cases_vax <- dat_cases %>%
select(date, ageRange, gender.x, date_hosp,
death, date_death, municipio, estado, date_1, manu_1, proveedor_1,
date_2, manu_2, proveedor_2, date_3, manu_3, proveedor_3, match_score) %>%
mutate(hosp = if_else(is.na(date_hosp), FALSE, TRUE)) %>%
rename(gender = "gender.x") %>%
data.table::as.data.table()
class(dat_cases_vax)
the_stamp <- now()
save(dat_cases_vax,
the_stamp,
file = "rdas/dat_cases_vax.rda")
source("~/R/vacunaspr/wrangle.R")
runApp()
dat_vax <- dat_vax %>%
select(-id)
colnames(dat_vax)
class(dat_vax)
the_stamp <- now()
save(dat_vax, the_stamp,
file = "rdas/dat_vax.rda")
source("~/R/vacunaspr/wrangle.R")
runApp()
runApp()
load("~/R/vacunaspr/rdas/vax_data_BP.rda")
load("~/R/vacunaspr/rdas/vax_data_preis.rda")
load("~/R/vacunaspr/rdas/vax_data_BP_today.rda")
View(vax_data_BP_today)
dat_vax <- vax_data %>%
mutate(ADMINISTRATION_DATE = convert_date(ADMINISTRATION_DATE)) %>%
mutate(INSERT_STAMP = convert_date(INSERT_STAMP)) %>%
mutate(manu = case_when(VACC_CODE == "2080" ~ "MOD",
VACC_CODE == "2089" ~ "PFR",
VACC_CODE == "2091" ~ "ATZ",
VACC_CODE == "2092" ~ "JSN",
VACC_CODE == "2090" ~ "OTR")) %>%
mutate(manu = factor(manu, levels = unique(manu))) %>%
mutate(original_date = ADMINISTRATION_DATE) %>%
mutate(ADMINISTRATION_DATE = if_else(ADMINISTRATION_DATE<first_day |
ADMINISTRATION_DATE>download_date,
as_date(NA),
ADMINISTRATION_DATE)) %>%
select(PATIENT_ID, PATIENT_GENDER, DOB, PATIENT_CITY, PATIENT_STATE, ADMINISTRATION_DATE, manu, original_date, INSERT_STAMP, FACILITY_NAME) %>%
setNames(c("id", "gender", "dob", "municipio", "estado", "date", "manu", "original_date", "insert_date", "proveedor")) %>%
mutate(gender = case_when(
is.na(gender) ~ "O",
gender=="F" ~ "F",
gender=="M" ~ "M",
gender=="U" ~ "O",
gender=="O" ~ "O")) %>%
mutate(gender = factor(gender, levels = gender_levels)) %>%
mutate(fixed_year = if_else(month(original_date)==12,
make_date(2020, month(original_date), day(original_date)),
make_date(2021, month(original_date), day(original_date)))) %>%
mutate(date = case_when(
(!is.na(date)) ~ date,
(is.na(date) & month(original_date) == 12 & year(original_date) == 2020) ~ make_date(2020, 12, 15),
(is.na(date) & dob!=original_date & as.numeric(insert_date - fixed_year) <= 30 & insert_date >= fixed_year) ~ fixed_year,
TRUE ~ insert_date)) %>%
arrange(date) %>%
group_by(id) %>%
mutate(dose = seq_along(date)) %>%
ungroup() %>%
mutate(age = floor(as.numeric(difftime(date, dob, units=c("days")))/365)) %>%
mutate(ageRange = cut(age, c(age_starts, Inf), labels = age_levels, right=F)) %>%
mutate(municipio = str_to_title(municipio)) %>%
mutate(municipio = fix_municipio(municipio)) %>%
mutate(municipio = replace_na(municipio, "No reportado")) %>%
mutate(municipio = factor(municipio, levels = unique(municipio))) %>%
select( -dob, -age, -fixed_year, -original_date) %>%
simplify_proveedor() %>%
mutate(proveedor = replace_na(proveedor, "No reportado")) %>%
mutate(proveedor = factor(proveedor, levels = unique(proveedor))) %>%
mutate(estado = replace_na(estado, "No reportado")) %>%
mutate(estado = factor(estado, levels = unique(estado)))
gender_levels <- c("F", "M", "O")
age_starts <- c(0, 5, 12, 18, seq(30, 80, 10))
age_ends <- c(age_starts[-1]-1, Inf)
age_levels <- paste(age_starts, age_ends, sep = "-")
age_levels[length(age_levels)] <- paste0(age_starts[length(age_levels)],"+")
View(vax_data)
# RAFAs date correction
convert_date <- function(d) as_date(d)
download_date <- today()
dat_vax <- vax_data %>%
mutate(ADMINISTRATION_DATE = convert_date(ADMINISTRATION_DATE)) %>%
mutate(INSERT_STAMP = convert_date(ymd_hms(INSERT_STAMP))) %>%
mutate(manu = case_when(VACC_CODE == "2080" ~ "MOD",
VACC_CODE == "2089" ~ "PFR",
VACC_CODE == "2091" ~ "ATZ",
VACC_CODE == "2092" ~ "JSN",
VACC_CODE == "2090" ~ "OTR")) %>%
mutate(manu = factor(manu, levels = unique(manu))) %>%
mutate(original_date = ADMINISTRATION_DATE) %>%
mutate(ADMINISTRATION_DATE = if_else(ADMINISTRATION_DATE<first_day |
ADMINISTRATION_DATE>download_date,
as_date(NA),
ADMINISTRATION_DATE)) %>%
select(PATIENT_ID, PATIENT_GENDER, DOB, PATIENT_CITY, PATIENT_STATE, ADMINISTRATION_DATE, manu, original_date, INSERT_STAMP, FACILITY_NAME) %>%
setNames(c("id", "gender", "dob", "municipio", "estado", "date", "manu", "original_date", "insert_date", "proveedor")) %>%
mutate(gender = case_when(
is.na(gender) ~ "O",
gender=="F" ~ "F",
gender=="M" ~ "M",
gender=="U" ~ "O",
gender=="O" ~ "O")) %>%
mutate(gender = factor(gender, levels = gender_levels)) %>%
mutate(fixed_year = if_else(month(original_date)==12,
make_date(2020, month(original_date), day(original_date)),
make_date(2021, month(original_date), day(original_date)))) %>%
mutate(date = case_when(
(!is.na(date)) ~ date,
(is.na(date) & month(original_date) == 12 & year(original_date) == 2020) ~ make_date(2020, 12, 15),
(is.na(date) & dob!=original_date & as.numeric(insert_date - fixed_year) <= 30 & insert_date >= fixed_year) ~ fixed_year,
TRUE ~ insert_date)) %>%
arrange(date) %>%
group_by(id) %>%
mutate(dose = seq_along(date)) %>%
ungroup() %>%
mutate(age = floor(as.numeric(difftime(date, dob, units=c("days")))/365)) %>%
mutate(ageRange = cut(age, c(age_starts, Inf), labels = age_levels, right=F)) %>%
mutate(municipio = str_to_title(municipio)) %>%
mutate(municipio = fix_municipio(municipio)) %>%
mutate(municipio = replace_na(municipio, "No reportado")) %>%
mutate(municipio = factor(municipio, levels = unique(municipio))) %>%
select( -dob, -age, -fixed_year, -original_date) %>%
simplify_proveedor() %>%
mutate(proveedor = replace_na(proveedor, "No reportado")) %>%
mutate(proveedor = factor(proveedor, levels = unique(proveedor))) %>%
mutate(estado = replace_na(estado, "No reportado")) %>%
mutate(estado = factor(estado, levels = unique(estado)))
View(vax_data_BP_today)
dat_vax <- full_join(filter(dat_vax, dose == 1),
filter(dat_vax, dose == 2),
by = "id", suffix = c("", "_2")) %>%
full_join(filter(dat_vax, dose == 3), by="id", suffix = c("_1" ,"_3")) %>%
mutate(ageRange_1 = if_else(!is.na(ageRange_2) & is.na(ageRange_1),
ageRange_2,
ageRange_1)) %>%
mutate(gender_1 = if_else(!is.na(gender_2) & is.na(gender_1),
gender_2,
gender_1)) %>%
mutate(gender_1 = if_else(gender_2 %in% c("F","M") & !gender_1 %in% c("F","M"),
gender_2,
gender_1)) %>%
select( -dose_1, -dose_2, -dose_3, -municipio_2, -municipio_3, -estado_2, -estado_3, -gender_2, -gender_3) %>%
rename(municipio = "municipio_1", gender = "gender_1", estado = "estado_1") %>%
data.table::as.data.table()
load(file.path(rda_path, "population-tabs.rda"))
muni_levels <- c(levels(pop_by_age_gender_municipio$municipio), "No reportado")
load(file.path(rda_path, "dates.rda"))
administradas <- sum(!is.na(dat_vax$date_1)) +
sum(!is.na(dat_vax$date_2)) +
sum(!is.na(dat_vax$date_3))
administradas_tasa <-
(filter(dat_vax, date_1 %in% span_range) %>% nrow +
filter(dat_vax, date_2 %in% span_range) %>% nrow +
filter(dat_vax, date_3 %in% span_range) %>% nrow )/length(span_range) * 7
dat_vax <- dat_vax[!manu_1 %in% c("ATZ","OTR") &
!manu_2 %in% c("ATZ","OTR") &
!manu_2 %in% c("ATZ","OTR"), ]
dat_vax$manu_1 <- droplevels(dat_vax$manu_1)
dat_vax$manu_2 <- droplevels(dat_vax$manu_2)
dat_vax$manu_3 <- droplevels(dat_vax$manu_3)
dat_vax[estado %in% c("PR", "No reportado") , c("vax_date", "booster_date", "booster_manu") := .(date_2, date_3, manu_3)]
dat_vax[manu_1 == "JSN",
c("vax_date", "booster_date", "ageRange_2", "manu_2", "booster_manu") := .(date_1, date_2, ageRange_1, manu_1, manu_2)]
dat_vax[!is.na(vax_date), vax_date := vax_date + days(14)]
dat_vax[vax_date > today(), vax_date := NA] ## not fully vax yet
## to early to be a booster
dat_vax[!is.na(booster_date) & manu_2 != "JSN" & booster_date < make_date(2021, 8, 13), c("booster_date", "booster_manu") := .(NA, NA)]
dat_vax[!is.na(booster_date) & manu_2 == "JSN" & booster_date < make_date(2021, 10, 22), c("booster_date", "booster_manu") := .(NA, NA)]
## last data without needing a booster
dat_vax[is.na(booster_date) & !is.na(vax_date) & manu_2 != "JSN", last_immune_date := date_2 + months(6)]
dat_vax[!is.na(booster_date) & manu_2 != "JSN", last_immune_date := booster_date + months(6)]
dat_vax[is.na(booster_date) & !is.na(vax_date) & manu_2 == "JSN", last_immune_date := date_1 + months(2)]
dat_vax[!is.na(booster_date) & manu_2 == "JSN", last_immune_date := booster_date + months(2)]
all_dates <- data.table(date = seq(first_day, last_day, "days"))
all_combs <- CJ(date = all_dates$date,
ageRange = levels(dat_vax$ageRange_1),
gender = levels(dat_vax$gender),
manu = levels(dat_vax$manu_1))
all_combs_muni <- CJ(date = all_dates$date,
ageRange = levels(dat_vax$ageRange_1),
gender = levels(dat_vax$gender),
manu = levels(dat_vax$manu_1),
municipio = muni_levels)
## Fully vaxed
daily_counts_vax_age_gender_manu <- dat_vax[!is.na(vax_date), .(full = .N),
keyby = .(vax_date, ageRange_2, gender, manu_2)]
names(daily_counts_vax_age_gender_manu) <- c("date", "ageRange", "gender", "manu", "full")
daily_counts_vax_age_gender_manu <- merge(all_combs, daily_counts_vax_age_gender_manu, all.x=TRUE)
daily_counts_vax_age_gender_manu[is.na(daily_counts_vax_age_gender_manu)] <- 0
counts_vax_age_gender_manu <- copy(daily_counts_vax_age_gender_manu)
counts_vax_age_gender_manu[, full := cumsum(full), keyby = .(ageRange, gender, manu)]
setnames(counts_vax_age_gender_manu, "full", "n")
## One dose
daily_counts_onedose_age_gender_manu <- dat_vax[!is.na(date_1), .(onedose = .N),
keyby = .(date_1, ageRange_1, gender, manu_1)]
names(daily_counts_onedose_age_gender_manu) <- c("date", "ageRange", "gender", "manu", "onedose")
daily_counts_onedose_age_gender_manu <- merge(all_combs,
daily_counts_onedose_age_gender_manu,
all.x=TRUE)
daily_counts_onedose_age_gender_manu[is.na(daily_counts_onedose_age_gender_manu)] <- 0
counts_onedose_age_gender_manu <- copy(daily_counts_onedose_age_gender_manu)
counts_onedose_age_gender_manu[, onedose := cumsum(onedose), keyby = .(ageRange, gender, manu)]
setnames(counts_onedose_age_gender_manu, "onedose", "n")
## Partially vaxed
counts_partial_age_gender_manu<- merge(counts_vax_age_gender_manu,
counts_onedose_age_gender_manu,
all = TRUE, by = c("date", "ageRange", "gender", "manu"))
counts_partial_age_gender_manu[ , n := n.y - n.x]
counts_partial_age_gender_manu <- counts_partial_age_gender_manu[, !c("n.y", "n.x")]
## Boosters
daily_counts_booster_age_gender_manu <- dat_vax[!is.na(booster_date), .(booster = .N),
keyby = .(booster_date, ageRange_3, gender, manu_3)]
names(daily_counts_booster_age_gender_manu) <- c("date", "ageRange", "gender", "manu", "booster")
daily_counts_booster_age_gender_manu <- merge(all_combs, daily_counts_booster_age_gender_manu, all.x=TRUE)
daily_counts_booster_age_gender_manu[is.na(daily_counts_booster_age_gender_manu)] <- 0
## Lost immunnity
daily_counts_lost_age_gender_manu <- dat_vax[!is.na(last_immune_date), .(lost = .N),
keyby = .(last_immune_date, ageRange_2, gender, manu_2)]
names(daily_counts_lost_age_gender_manu) <- c("date", "ageRange", "gender", "manu", "lost")
#daily_counts_lost_age_gender_manu %>% group_by(week=round_date(date,"week")) %>% summarize(need_booster=sum(lost)) %>% ggplot(aes(week, need_booster)) + scale_y_continuous(labels = scales::comma) + geom_line()
daily_counts_lost_age_gender_manu <- merge(all_combs, daily_counts_lost_age_gender_manu, all.x=TRUE)
daily_counts_lost_age_gender_manu[is.na(daily_counts_lost_age_gender_manu)] <- 0
counts_lost_age_gender_manu <- copy(daily_counts_lost_age_gender_manu)
counts_lost_age_gender_manu[, lost := cumsum(lost), keyby = .(ageRange, gender, manu)]
immune <- merge(counts_lost_age_gender_manu, counts_vax_age_gender_manu,
all = TRUE, by = c("date", "ageRange", "gender", "manu"))
immune[ , n := n - lost]
immune <- immune[, !c("lost")]
daily_vax_counts <- merge(daily_counts_onedose_age_gender_manu,
daily_counts_vax_age_gender_manu,
all = TRUE, by = c("date", "ageRange", "gender", "manu"))
daily_vax_counts <- merge(daily_vax_counts,
daily_counts_booster_age_gender_manu,
all = TRUE, by = c("date", "ageRange", "gender", "manu"))
daily_vax_counts <- merge(daily_vax_counts,
daily_counts_lost_age_gender_manu,
all = TRUE, by = c("date", "ageRange", "gender", "manu"))
daily_vax_counts$ageRange <- factor(daily_vax_counts$ageRange, levels = age_levels)
## Fully vaxed
daily_counts_vax_age_gender_manu_muni <- dat_vax[!is.na(vax_date), .(full = .N),
keyby = .(vax_date, ageRange_2, gender, manu_2, municipio)]
names(daily_counts_vax_age_gender_manu_muni) <- c("date", "ageRange", "gender", "manu", "municipio", "full")
daily_counts_vax_age_gender_manu_muni <- merge(all_combs_muni, daily_counts_vax_age_gender_manu_muni, all.x=TRUE)
daily_counts_vax_age_gender_manu_muni[is.na(daily_counts_vax_age_gender_manu_muni)] <- 0
counts_vax_age_gender_manu_muni <- copy(daily_counts_vax_age_gender_manu_muni)
counts_vax_age_gender_manu_muni[, full := cumsum(full), keyby = .(ageRange, gender, manu, municipio)]
setnames(counts_vax_age_gender_manu_muni, "full", "n")
## One dose
daily_counts_onedose_age_gender_manu_muni <- dat_vax[!is.na(date_1), .(onedose = .N),
keyby = .(date_1, ageRange_1, gender, manu_1, municipio)]
names(daily_counts_onedose_age_gender_manu_muni) <- c("date", "ageRange", "gender", "manu", "municipio", "onedose")
daily_counts_onedose_age_gender_manu_muni <- merge(all_combs_muni,
daily_counts_onedose_age_gender_manu_muni,
all.x=TRUE)
daily_counts_onedose_age_gender_manu_muni[is.na(daily_counts_onedose_age_gender_manu_muni)] <- 0
counts_onedose_age_gender_manu_muni <- copy(daily_counts_onedose_age_gender_manu_muni)
counts_onedose_age_gender_manu_muni[, onedose := cumsum(onedose), keyby = .(ageRange, gender, manu, municipio)]
setnames(counts_onedose_age_gender_manu_muni, "onedose", "n")
## Partially vaxed
counts_partial_age_gender_manu_muni<- merge(counts_vax_age_gender_manu_muni,
counts_onedose_age_gender_manu_muni,
all = TRUE, by = c("date", "ageRange", "gender", "manu", "municipio"))
counts_partial_age_gender_manu_muni[ , n := n.y - n.x]
counts_partial_age_gender_manu_muni <- counts_partial_age_gender_manu_muni[, !c("n.y", "n.x")]
## Boosters
daily_counts_booster_age_gender_manu_muni <- dat_vax[!is.na(booster_date), .(booster = .N),
keyby = .(booster_date, ageRange_3, gender, manu_3, municipio)]
names(daily_counts_booster_age_gender_manu_muni) <- c("date", "ageRange", "gender", "manu", "municipio", "booster")
daily_counts_booster_age_gender_manu_muni <- merge(all_combs_muni, daily_counts_booster_age_gender_manu_muni, all.x=TRUE)
daily_counts_booster_age_gender_manu_muni[is.na(daily_counts_booster_age_gender_manu_muni)] <- 0
## Lost immunnity
daily_counts_lost_age_gender_manu_muni <- dat_vax[!is.na(last_immune_date), .(lost = .N),
keyby = .(last_immune_date, ageRange_2, gender, manu_2, municipio)]
names(daily_counts_lost_age_gender_manu_muni) <- c("date", "ageRange", "gender", "manu", "municipio", "lost")
#daily_counts_lost_age_gender_manu_muni %>% group_by(week=round_date(date,"week")) %>% summarize(need_booster=sum(lost)) %>% ggplot(aes(week, need_booster)) +  scale_y_continuous(labels = scales::comma) + geom_line()
daily_counts_lost_age_gender_manu_muni <- merge(all_combs_muni, daily_counts_lost_age_gender_manu_muni, all.x=TRUE)
daily_counts_lost_age_gender_manu_muni[is.na(daily_counts_lost_age_gender_manu_muni)] <- 0
counts_lost_age_gender_manu_muni <- copy(daily_counts_lost_age_gender_manu_muni)
counts_lost_age_gender_manu_muni[, lost := cumsum(lost), keyby = .(ageRange, gender, manu, municipio)]
daily_vax_counts_by_municipio <- merge(daily_counts_onedose_age_gender_manu_muni,
daily_counts_vax_age_gender_manu_muni,
all = TRUE, by = c("date", "ageRange", "gender", "manu", "municipio"))
daily_vax_counts_by_municipio <- merge(daily_vax_counts_by_municipio,
daily_counts_booster_age_gender_manu_muni,
all = TRUE, by = c("date", "ageRange", "gender", "manu", "municipio"))
daily_vax_counts_by_municipio <- merge(daily_vax_counts_by_municipio,
daily_counts_lost_age_gender_manu_muni,
all = TRUE, by = c("date", "ageRange", "gender", "manu", "municipio"))
daily_vax_counts_by_municipio$ageRange <- factor(daily_vax_counts_by_municipio$ageRange, levels = age_levels)
daily_vax_counts_by_municipio$municipio <-
factor(daily_vax_counts_by_municipio$municipio, levels = muni_levels)
unvax <- counts_onedose_age_gender_manu[ , .(total = sum(n)),
keyby = .(date, ageRange, gender)]
unvax <- merge(unvax, pop_by_age_gender, all.x = TRUE,
by = c("ageRange", "gender"))
unvax[,n := poblacion - total]
unvax[,manu := "UNV"]
unvax <- unvax[,c("date", "ageRange","gender","manu", "n")]
poblacion <- rbind(counts_vax_age_gender_manu[,status:="VAX"],
counts_partial_age_gender_manu[,status:="PAR"],
unvax[,status:="UNV"])
poblacion$status <- factor(poblacion$status, levels = c("UNV", "PAR", "VAX"))
poblacion$ageRange <- factor(poblacion$ageRange, levels = age_levels)
### by municipio
unvax <- counts_onedose_age_gender_manu_muni[ , .(total = sum(n)),
keyby = .(date, ageRange, gender, municipio)]
unvax <- merge(unvax, pop_by_age_gender_municipio, all.x = TRUE,
by = c("ageRange", "gender", "municipio"))
unvax[, n := poblacion - total]
unvax[ ,manu := "UNV"]
unvax <- unvax[,c("date", "municipio","ageRange","gender","manu", "n")]
poblacion_muni <- rbind(counts_vax_age_gender_manu_muni[,status:="VAX"],
counts_partial_age_gender_manu_muni[,status:="PAR"],
unvax[,status:="UNV"])
poblacion_muni$status <- factor(poblacion_muni$status, levels = c("UNV", "PAR", "VAX"))
poblacion_muni$ageRange <- factor(poblacion_muni$ageRange, levels = age_levels)
poblacion_muni$municipio <-
factor(poblacion_muni$municipio, levels = muni_levels)
### PIRAMIDE
tab <- poblacion %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = pmax(0, n)) %>%
mutate(n = ifelse(gender=="M", -n, n)) %>%
arrange(gender, ageRange) %>%
mutate(n = n/sum(abs(n))) %>%
mutate(etatus = recode(status, UNV = "No vacunados", PAR = "Parcial", VAX = "Vacunados")) %>%
rename(estatus = status) %>%
mutate(municipio = "Todos")
tab_muni <- poblacion_muni %>%
filter(municipio!="No reportado") %>%
filter(date == max(date) & gender %in% c("M","F")) %>%
group_by(municipio, ageRange, gender, status) %>%
summarize(n = sum(n), .groups = "drop") %>%
mutate(n = pmax(0, n)) %>%
mutate(n = ifelse(gender=="M", -n, n)) %>%
arrange(municipio, gender, ageRange) %>%
group_by(municipio) %>%
mutate(n = n/sum(abs(n))) %>%
ungroup() %>%
mutate(etatus = recode(status, UNV = "No vacunados", PAR = "Parcial", VAX = "Vacunados")) %>%
rename(estatus = status)
piramide <- bind_rows(tab, tab_muni)
piramide_tab <- daily_vax_counts %>%
filter(gender %in% c("M", "F")) %>%
group_by(ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender, by = c("ageRange", "gender")) %>%
mutate(municipio = "Todos")
piramide_tab_muni <- daily_vax_counts_by_municipio %>%
filter(gender %in% c("M", "F") & municipio!="No reportado") %>%
group_by(municipio, ageRange, gender) %>%
summarize(onedose = sum(onedose), full = sum(full),
booster=sum(booster), lost = sum(lost), .groups = "drop") %>%
mutate(immune = full - lost) %>%
left_join(pop_by_age_gender_municipio, by = c("municipio","ageRange", "gender"))
piramide_tab <- bind_rows(piramide_tab, piramide_tab_muni)
rm(daily_counts_onedose_age_gender_manu,
daily_counts_booster_age_gender_manu,
daily_counts_lost_age_gender_manu,
daily_counts_vax_age_gender_manu,
counts_onedose_age_gender_manu,
counts_partial_age_gender_manu,
counts_vax_age_gender_manu,
daily_counts_onedose_age_gender_manu_muni,
daily_counts_booster_age_gender_manu_muni,
daily_counts_lost_age_gender_manu_muni,
daily_counts_vax_age_gender_manu_muni,
counts_onedose_age_gender_manu_muni,
counts_partial_age_gender_manu_muni,
counts_vax_age_gender_manu_muni,
piramide_tab_muni,
tab, tab_muni)
## cases
load(file.path(rda_path, "dat_cases_vax.rda"))
dat_cases <- dat_cases_vax[!manu_1 %in% c("ATZ","OTR") &
!manu_2 %in% c("ATZ","OTR") &
!manu_2 %in% c("ATZ","OTR"), ]
dat_cases$manu_1 <- droplevels(dat_cases$manu_1)
dat_cases$manu_2 <- droplevels(dat_cases$manu_2)
dat_cases$manu_3 <- droplevels(dat_cases$manu_3)
dat_cases[estado %in% c("PR", "No reportado") , c("vax_date", "booster_date", "booster_manu") := .(date_2, date_3, manu_3)]
dat_cases[manu_1 == "JSN",
c("vax_date", "booster_date", "manu_2", "booster_manu") := .(date_1, date_2, manu_1, manu_2)]
dat_cases$manu <- factor(replace_na(as.character(dat_cases$manu_1), "UNV"),
levels = manu_levels)
dat_cases[!is.na(vax_date), vax_date := vax_date + days(14)]
manu_levels <- c("UNV", "MOD", "PFR", "JSN")
dat_cases$manu <- factor(replace_na(as.character(dat_cases$manu_1), "UNV"),
levels = manu_levels)
dat_cases[!is.na(vax_date), vax_date := vax_date + days(14)]
dat_cases[, status := "UNV"]
dat_cases[date > date_1, status := "PAR"]
dat_cases[date > vax_date, status := "VAX"]
dat_cases[date <= date_1, manu := "UNV"]
dat_cases$status <- factor(dat_cases$status, levels = c("UNV", "PAR", "VAX"))
dat_cases$booster <- FALSE
dat_cases[!is.na(booster_date) & status == "VAX", booster := date > booster_date]
all_combs <- CJ(date = all_dates$date,
ageRange = levels(dat_cases$ageRange),
gender = levels(dat_cases$gender),
status = levels(dat_cases$status),
manu = manu_levels)
all_combs <- all_combs[!(manu == "UNV" & status !="UNV") &
!(manu != "UNV" & status =="UNV"),]
counts_cases <- dat_cases[,.(cases = .N),
keyby = .(date, ageRange, gender, manu, status)]
counts_hosp <- dat_cases[hosp==TRUE, .(hosp = .N),
keyby = .(date_hosp, ageRange, gender, manu, status)]
setnames(counts_hosp, "date_hosp", "date")
counts_death <- dat_cases[death==TRUE,.(death = .N),
keyby = .(date_death, ageRange, gender, manu, status)]
setnames(counts_death, "date_death", "date")
counts <- merge(merge(counts_cases, counts_hosp, all = TRUE), counts_death, all = TRUE)
counts <- merge(all_combs, counts, all.x = TRUE)
counts[is.na(counts)] <- 0
counts <- merge(counts, poblacion, all.x = TRUE)
counts$manu <- factor(counts$manu, levels = manu_levels)
counts$status <- factor(counts$status,  levels = c("UNV", "PAR", "VAX"))
counts$ageRange <- factor(counts$ageRange, levels = age_levels)
###################
##counts by booster
##################
counts_cases <- dat_cases[booster==TRUE ,.(cases = .N),
keyby = .(date, ageRange, gender, manu)]
counts_hosp <- dat_cases[booster==TRUE & hosp==TRUE, .(hosp = .N),
keyby = .(date_hosp, ageRange, gender, manu)]
setnames(counts_hosp, "date_hosp", "date")
counts_death <- dat_cases[booster==TRUE & death==TRUE,.(death = .N),
keyby = .(date_death, ageRange, gender, manu)]
setnames(counts_death, "date_death", "date")
all_combs <- CJ(date = all_dates$date,
ageRange = levels(dat_cases$ageRange),
gender = levels(dat_cases$gender),
manu = manu_levels[-1])
booster_counts <- merge(merge(counts_cases, counts_hosp, all = TRUE),
counts_death, all = TRUE)
booster_counts <- merge(all_combs, booster_counts, all.x = TRUE)
booster_counts[is.na(booster_counts)] <- 0
booster_poblacion <- copy(daily_vax_counts)
booster_poblacion[, n := cumsum(booster), keyby = .(ageRange, gender, manu)]
booster_poblacion <- booster_poblacion[, !c("onedose","full","booster")]
booster_counts <- merge(booster_counts, booster_poblacion, by = c("date", "ageRange", "gender", "manu"))
booster_counts$manu <- factor(booster_counts$manu, levels=manu_levels[-1])
primera <- sum(!is.na(dat_vax$date_1))
primera_prop <- primera/pr_pop
completa <- sum(!is.na(dat_vax$vax_date))
completa_prop <- completa/pr_pop
the_immune <- immune %>% filter(date == last_day) %>% summarize(n=sum(n)) %>% pull(n)
the_immune_prop <- the_immune/pr_pop
booster <- sum(!is.na(dat_vax$booster_date))
booster_prop <- booster/pr_pop
tasas <- daily_vax_counts %>%
filter(date %in% span_range) %>%
summarize(onedose = sum(onedose)/length(span_range) * 7,
full = sum(full)/length(span_range)* 7 ,
immune = (sum(full) - sum(lost))/length(span_range)*7,
booster = sum(booster)/length(span_range)  * 7)
summary_tab <- data.frame(names = c("Vacunas administradas",
"Personas con por lo menos 1 dosis",
"Personas con dosis completa",
"Personas con dosis completa sin necesidad de booster",
"Personas con boosters"),
total = c(administradas, primera, completa, the_immune, booster),
porciento = c(NA, primera_prop, completa_prop, the_immune_prop, booster_prop),
tasas = tasas <- c(administradas_tasa, tasas$onedose, tasas$full, tasas$immune, tasas$booster))
outcome_tab <- counts %>% group_by(status, manu) %>%
summarize(n = sum(n, na.rm = TRUE)/365,
cases = sum(cases), hosp=sum(hosp),
death = sum(death),
.groups = "drop") %>%
mutate(rate_cases = cases/n, rate_hosp = hosp/n, rate_death = death/n)
outcome_tab_booster <-  booster_counts %>% group_by(manu) %>%
summarize(n = sum(n, na.rm = TRUE)/365,
cases = sum(cases), hosp=sum(hosp),
death = sum(death),
.groups = "drop") %>%
mutate(rate_cases = cases/n, rate_hosp = hosp/n, rate_death = death/n,
status = "Con booster")
outcome_tab <- bind_rows(outcome_tab, outcome_tab_booster)
totals <- poblacion %>%
filter(date == last_day) %>%
group_by(manu, status) %>%
summarize(total = sum(n, na.rm=TRUE), .groups = "drop")
totals_booster <- daily_vax_counts %>%
group_by(manu) %>%
summarize(total = sum(booster), .groups = "drop") %>%
mutate(status = "Con booster")
totals <- bind_rows(totals, totals_booster)
outcome_tab <- left_join(outcome_tab, totals, by = c("manu", "status"))
save(counts, file=file.path(rda_path ,"counts.rda"))
save(summary_tab, outcome_tab, file=file.path(rda_path ,"tabs.rda"))
View(outcome_tab)
View(outcome_tab_booster)
dbDisconnect(con)
